{% extends "base.html" %} {% block content %}
<div class="container">
  <h2>Input Financial Transactions</h2>
  <form id="transactionForm" method="POST">
    <div id="transactionFields">
      <div class="form-group">
        <label for="name1">Name</label>
        <input
          type="text"
          name="name[]"
          id="name1"
          required
          class="form-control"
        />
      </div>
      <div class="form-group">
        <label for="amount1">Amount</label>
        <input
          type="number"
          step="0.01"
          name="amount[]"
          id="amount1"
          required
          class="form-control"
        />
      </div>
      <div class="form-group">
        <label for="category1">Category</label>
        <select name="category[]" id="category1" required class="form-control">
          <option value="">Select a Category</option>
          <option value="savings">Savings</option>
          <option value="wants">Wants</option>
          <option value="needs">Needs</option>
        </select>
      </div>
    </div>
    <button type="button" id="addMore" class="btn btn-info">Add More</button>
    <button type="button" id="generateChart" class="btn btn-primary">
      Generate Chart
    </button>
    <button
      type="button"
      class="btn btn btn-primary"
      style="display: in-line-block"
    >
      Save Chart
    </button>
  </form>
  <div id="piechart" style="width: 500px; height: 500px; margin: 0 auto"></div>
</div>

<script>
  document.getElementById("addMore").addEventListener("click", function () {
    var container = document.getElementById("transactionFields");
    var index = container.children.length + 1; // to create unique IDs for new fields
    var newFieldGroup = document.createElement("div");
    newFieldGroup.innerHTML = `
          <div class="form-group">
              <label for="name${index}">Name</label>
              <input type="text" name="name[]" id="name${index}" required class="form-control">
          </div>
          <div class="form-group">
              <label for="amount${index}">Amount</label>
              <input type="number" step="0.01" name="amount[]" id="amount${index}" required class="form-control">
          </div>
          <div class="form-group">
              <label for="category${index}">Category</label>
              <select name="category[]" id="category${index}" required class="form-control" onchange="calculateTotals()">
                  <option value="">Select a Category</option>
                  <option value="savings">Savings</option>
                  <option value="wants">Wants</option>
                  <option value="needs">Needs</option>
              </select>
          </div>`;
    container.appendChild(newFieldGroup);

    calculateTotals(); // Recalculate totals when a new field is added
  });
</script>

<script
  type="text/javascript"
  src="https://www.gstatic.com/charts/loader.js"
></script>
<script type="text/javascript">
  google.charts.load("current", { packages: ["corechart"] });
  google.charts.setOnLoadCallback(drawChart);

  function drawChart() {
    var totals = calculateTotals();

    var data = new google.visualization.DataTable();
    data.addColumn("string", "Category");
    data.addColumn("number", "Amount");

    data.addRows([
      ["Savings", totals.savings],
      ["Wants", totals.wants],
      ["Needs", totals.needs],
    ]);

    var options = {
      title: "Expenses Distribution by Category",
      width: 900,
      height: 500,
    };

    // Check if chart exists, remove it if it does
    if (chart) {
      chart.clearChart();
      chart = null;
    }

    var chart = new google.visualization.PieChart(
      document.getElementById("piechart")
    );
    chart.draw(data, options);
  }

  function calculateTotals() {
    var amounts = document.getElementsByName("amount[]");
    var categories = document.getElementsByName("category[]");
    var totals = { savings: 0, wants: 0, needs: 0 };

    for (var i = 0; i < amounts.length; i++) {
      var amount = parseFloat(amounts[i].value);
      var category = categories[i].value;
      totals[category] += amount;
    }

    console.log("Savings: " + totals.savings);
    console.log("Wants: " + totals.wants);
    console.log("Needs: " + totals.needs);

    return totals;
  }

  document
    .getElementById("generateChart")
    .addEventListener("click", function () {
      drawChart();
    });
</script>

<!-- Assuming this is within a block content in a Jinja2 template that extends base.html -->
<button id="deleteAllTransactions" class="btn btn-danger">
  Clear All My Expenses
</button>

<script>
  document
    .getElementById("deleteAllTransactions")
    .addEventListener("click", function () {
      if (
        confirm(
          "Are you sure you want to clear all transactions? This cannot be undone!"
        )
      ) {
        window.location.reload(); // Reload the page to update the list of transactions
      }
    });
</script>

{% endblock %}
